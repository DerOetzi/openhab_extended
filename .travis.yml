#
# ------------------------------------------------------------------------------
#          NOTE: THIS TRAVIS CONFIGURATION IS GENERATED VIA "update.sh"
#
#                       PLEASE DO NOT EDIT IT DIRECTLY.
# ------------------------------------------------------------------------------
#
sudo: required
language: bash
branches:
  only:
    - master
services:
  - docker
before_install:
  - sudo apt-get install -y uidmap
  - docker info
  - docker run --rm --privileged multiarch/qemu-user-static:register --reset
  - ARCHES="amd64 armhf arm64"
install:
  - mkdir $VERSION
  - cp template/manifest.yml $VERSION/
  - sed -i -e "s|%version%|$VERSION|" -e "s|%tags%|$TAGS|" $VERSION/manifest.yml
  - echo "-------- Manifest $VERSION --------";
  - cat $VERSION/manifest.yml
  - for ARCH in $ARCHES; do
        cp template/Dockerfile $VERSION/Dockerfile.$ARCH;
        sed -i -e "s|%version%|$VERSION|" -e "s|%arch%|$ARCH|" $VERSION/Dockerfile.$ARCH;
        sed -i -e "s|%signal_version%|$SIGNAL_VERSION|" $VERSION/Dockerfile.$ARCH;
        echo "-------- Dockerfile $VERSION $ARCH --------";
        cat $VERSION/Dockerfile.$ARCH;
        docker build --build-arg VCS_REF=$TRAVIS_COMMIT --build-arg BUILD_DATE=$(date +"%Y-%m-%dT%H:%M:%SZ") --build-arg VERSION=$VERSION -f $VERSION/Dockerfile.$ARCH -t $DOCKER_REPO:$VERSION-$ARCH $VERSION;
        docker run --rm $DOCKER_REPO:$VERSION-$ARCH uname -a;
    done
after_success:
  - export MT_SHA256="80906341c3306e3838437eeb08fff5da2c38bd89149019aa301c7745e07ea8f9"
  - sudo curl -fSL "https://github.com/estesp/manifest-tool/releases/download/v0.9.0/manifest-tool-linux-amd64" -o "/usr/local/bin/manifest-tool"
  - echo "${MT_SHA256}  /usr/local/bin/manifest-tool" | sha256sum -c -
  - sudo chmod a+x "/usr/local/bin/manifest-tool"
  - echo "manifest-tool installed!"
  - docker login -u=$DOCKER_USERNAME -p=$DOCKER_PASSWORD
  - for ARCH in $ARCHES; do
        docker push $DOCKER_REPO:$VERSION-$ARCH;
    done
  - manifest-tool push from-spec $VERSION/manifest.yml
matrix:
  fast_finish: true
env:
  global:
    - SIGNAL_VERSION=0.6.5
  matrix:
    - VERSION=2.4.0 TAGS=
    - VERSION=2.5.0 TAGS=latest
    - VERSION=3.0.0-snapshot TAGS=snapshot
